<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jump Counter & Fitness Analyzer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #000000;
        }
        .video-mirror {
            transform: scaleX(-1);
        }
        .neon-green {
            color: #2ECC71;
        }
        .neon-green-bg {
            background-color: #2ECC71;
        }
        .neon-glow {
            text-shadow: 0 0 5px #2ECC71, 0 0 10px #2ECC71;
        }
        .good-jump-glow {
            text-shadow: 0 0 5px #FFD700, 0 0 10px #FFD700;
            color: #FFD700;
        }
        .partial-glow {
            text-shadow: 0 0 5px #FF6B00, 0 0 10px #FF6B00;
            color: #FF6B00;
        }
    </style>
</head>
<body class="min-h-screen bg-black">
    <div class="p-4 sm:p-8">
        <div class="max-w-5xl mx-auto">
            <h1 class="text-3xl sm:text-4xl font-bold neon-green neon-glow mb-2 text-center">
                JUMP COUNTER & FITNESS ANALYZER
            </h1>
            <p class="neon-green text-center mb-6 sm:mb-8 text-sm sm:text-base opacity-80">
                Stand facing camera - Full body must be visible when jumping
            </p>

            <div class="bg-gray-900 border-2 border-green-800 rounded-2xl shadow-2xl p-4 sm:p-6 mb-6">
                <!-- Video Feed -->
                <div class="relative bg-black rounded-lg overflow-hidden mb-6 border-2 border-gray-800" style="height: 450px;">
                    <video id="video" autoplay playsinline muted class="w-full h-full object-cover video-mirror"></video>
                    <canvas id="canvas" class="hidden"></canvas>
                    
                    <div id="cameraPlaceholder" class="absolute inset-0 flex items-center justify-center bg-black">
                        <div class="text-center p-4">
                            <svg class="w-16 h-16 neon-green mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                            <p id="errorMessage" class="text-red-500 mb-4 hidden"></p>
                            <p class="neon-green mb-4 opacity-70">Camera not initialized</p>
                            <button id="enableCameraBtn" class="neon-green-bg text-black px-6 py-2 rounded-lg font-bold transition hover:opacity-80">
                                ENABLE CAMERA
                            </button>
                        </div>
                    </div>

                    <!-- Position & Height Overlay -->
                    <div id="positionOverlay" class="absolute top-4 left-4 bg-black bg-opacity-90 border-2 border-green-800 text-white px-4 py-2 rounded-lg hidden">
                        <div class="text-sm neon-green font-bold">
                            STATUS: <span id="positionText" class="uppercase">STANDING</span>
                        </div>
                        <div class="text-sm neon-green font-bold mt-1">
                            HEAD Y: <span id="headYText">0</span>
                        </div>
                        <div class="text-xs text-gray-400 font-mono mt-1">
                            PHASE: <span id="phaseText">GROUND</span>
                        </div>
                    </div>

                    <!-- Jump Visualization -->
                    <div id="jumpMeter" class="absolute top-4 right-4 bg-black bg-opacity-90 border-2 border-green-800 rounded-lg p-3 hidden">
                        <div class="text-xs neon-green font-bold mb-2 text-center">JUMP HEIGHT</div>
                        <div class="w-16 h-48 bg-gray-800 rounded relative overflow-hidden">
                            <!-- Height markers -->
                            <div class="absolute w-full h-px bg-yellow-500 opacity-50" style="bottom: 72%;"></div>
                            <div class="text-xs text-yellow-500 absolute right-1" style="bottom: 72%; font-size: 8px;">26"</div>
                            <div class="absolute w-full h-px bg-green-500 opacity-50" style="bottom: 44%;"></div>
                            <div class="text-xs neon-green absolute right-1" style="bottom: 44%; font-size: 8px;">16"</div>
                            <!-- Jump indicator -->
                            <div id="jumpIndicator" class="absolute bottom-0 w-full bg-gradient-to-t from-green-500 to-green-300 transition-all duration-100" style="height: 0%"></div>
                        </div>
                    </div>
                </div>

                <!-- Stats Dashboard -->
                <div class="grid grid-cols-4 gap-2 sm:gap-4 mb-6">
                    <div class="bg-black border-4 border-green-800 rounded-xl p-3 sm:p-5 text-center">
                        <div id="totalJumps" class="text-3xl sm:text-5xl font-bold mb-1 neon-green neon-glow">0</div>
                        <div class="text-xs sm:text-sm neon-green font-bold opacity-70">TOTAL JUMPS</div>
                    </div>
                    <div class="bg-black border-4 border-green-800 rounded-xl p-3 sm:p-5 text-center">
                        <div id="normalJumps" class="text-3xl sm:text-5xl font-bold mb-1 neon-green neon-glow">0</div>
                        <div class="text-xs sm:text-sm neon-green font-bold opacity-70">NORMAL (16-26")</div>
                    </div>
                    <div class="bg-black border-4 border-yellow-700 rounded-xl p-3 sm:p-5 text-center">
                        <div id="goodJumps" class="text-3xl sm:text-5xl font-bold mb-1 good-jump-glow">0</div>
                        <div class="text-xs sm:text-sm text-yellow-500 font-bold opacity-70">GOOD (>26")</div>
                    </div>
                    <div class="bg-black border-4 border-orange-700 rounded-xl p-3 sm:p-5 text-center">
                        <div id="partialJumps" class="text-3xl sm:text-5xl font-bold mb-1 partial-glow">0</div>
                        <div class="text-xs sm:text-sm text-orange-500 font-bold opacity-70">PARTIAL (<16")</div>
                    </div>
                </div>

                <!-- Timer & Fitness Score -->
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="bg-black border-2 border-green-800 rounded-lg p-4 text-center">
                        <div id="timerDisplay" class="text-5xl font-bold neon-green neon-glow mb-1">30</div>
                        <div class="text-sm neon-green font-bold opacity-70">SECONDS LEFT</div>
                    </div>
                    <div class="bg-black border-2 border-green-800 rounded-lg p-4 text-center">
                        <div id="fitnessScore" class="text-5xl font-bold neon-green neon-glow mb-1">--</div>
                        <div class="text-sm neon-green font-bold opacity-70">FITNESS SCORE</div>
                    </div>
                </div>

                <!-- Status -->
                <div class="bg-black border-2 border-green-800 rounded-lg p-4 mb-6 text-center">
                    <p id="statusText" class="text-base sm:text-xl font-bold neon-green neon-glow">CLICK "ENABLE CAMERA" TO START</p>
                </div>

                <!-- Controls -->
                <div class="flex flex-wrap gap-3 sm:gap-4 justify-center">
                    <button id="startBtn" class="hidden items-center gap-2 neon-green-bg text-black px-6 sm:px-8 py-3 rounded-lg font-bold transition hover:opacity-80">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M6.3 2.841A1.5 1.5 0 004 4.11V15.89a1.5 1.5 0 002.3 1.269l9.344-5.89a1.5 1.5 0 000-2.538L6.3 2.84z"/>
                        </svg>
                        START TEST
                    </button>
                    <button id="stopBtn" class="hidden items-center gap-2 bg-red-600 text-white px-6 sm:px-8 py-3 rounded-lg font-bold transition hover:bg-red-700">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 00-1 1v4a1 1 0 001 1h4a1 1 0 001-1V8a1 1 0 00-1-1H8z" clip-rule="evenodd"/>
                        </svg>
                        STOP
                    </button>
                    <button id="resetBtn" class="flex items-center gap-2 bg-gray-700 text-white px-6 sm:px-8 py-3 rounded-lg font-bold transition hover:bg-gray-600">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                        </svg>
                        RESET
                    </button>
                </div>
            </div>

            <!-- Instructions & Fitness Guide -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="bg-gray-900 border-2 border-green-800 rounded-xl p-6">
                    <h2 class="text-xl font-bold mb-4 neon-green">INSTRUCTIONS</h2>
                    <ol class="space-y-2 text-sm neon-green opacity-80">
                        <li><strong>1.</strong> Enable camera and allow access</li>
                        <li><strong>2.</strong> Stand 6-8 feet from camera</li>
                        <li><strong>3.</strong> Ensure FULL body visible (head to feet)</li>
                        <li><strong>4.</strong> Click START TEST for 30-second assessment</li>
                        <li><strong>5.</strong> Jump VERTICALLY - land in same spot</li>
                        <li><strong>6.</strong> Stand still for 1 second between jumps</li>
                    </ol>
                </div>
                
                <div class="bg-gray-900 border-2 border-green-800 rounded-xl p-6">
                    <h2 class="text-xl font-bold mb-4 neon-green">FITNESS SCORING</h2>
                    <div class="space-y-2 text-sm neon-green opacity-80">
                        <div class="flex justify-between"><span>PARTIAL Jump (<16")</span><span class="text-orange-500">Low fitness</span></div>
                        <div class="flex justify-between"><span>NORMAL Jump (16-26")</span><span class="neon-green">Good fitness</span></div>
                        <div class="flex justify-between"><span>GOOD Jump (>26")</span><span class="text-yellow-500">Excellent!</span></div>
                        <div class="mt-4 pt-4 border-t border-green-900">
                            <strong>Score Formula:</strong> (Good×3 + Normal×2 + Partial×0.5) ÷ Time
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let video = document.getElementById('video');
        let canvas = document.getElementById('canvas');
        let ctx = canvas.getContext('2d');
        let stream = null;
        let isActive = false;
        let totalJumpsCount = 0;
        let normalJumpsCount = 0;
        let goodJumpsCount = 0;
        let partialJumpsCount = 0;
        let timeLeft = 30;
        let cameraReady = false;
        let animationId = null;
        let timerId = null;
        
        // Improved detection - track HEAD position instead of feet
        let baselineHeadY = 0;
        let headYHistory = [];
        const HISTORY_SIZE = 5;
        const JUMP_THRESHOLD = 30;
        const GOOD_THRESHOLD = 50;
        const GROUND_TOLERANCE = 15;
        
        let jumpState = {
            phase: 'ground',
            maxHeightReached: 0,
            jumpStartY: 0,
            hasLeftGround: false,
            hasReachedPeak: false,
            groundFrames: 0,
            requiredGroundFrames: 10
        };

        // DOM elements
        const enableCameraBtn = document.getElementById('enableCameraBtn');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const resetBtn = document.getElementById('resetBtn');
        const cameraPlaceholder = document.getElementById('cameraPlaceholder');
        const positionOverlay = document.getElementById('positionOverlay');
        const jumpMeter = document.getElementById('jumpMeter');
        const errorMessage = document.getElementById('errorMessage');
        const statusText = document.getElementById('statusText');
        const totalJumps = document.getElementById('totalJumps');
        const normalJumps = document.getElementById('normalJumps');
        const goodJumps = document.getElementById('goodJumps');
        const partialJumps = document.getElementById('partialJumps');
        const timerDisplay = document.getElementById('timerDisplay');
        const fitnessScore = document.getElementById('fitnessScore');
        const positionText = document.getElementById('positionText');
        const headYText = document.getElementById('headYText');
        const phaseText = document.getElementById('phaseText');
        const jumpIndicator = document.getElementById('jumpIndicator');

        async function enableCamera() {
            errorMessage.classList.add('hidden');
            statusText.textContent = 'REQUESTING CAMERA ACCESS...';
            
            try {
                stream = await navigator.mediaDevices.getUserMedia({
                    video: { 
                        facingMode: 'user',
                        width: { ideal: 640 },
                        height: { ideal: 480 }
                    },
                    audio: false
                });
                
                video.srcObject = stream;
                
                video.onloadedmetadata = () => {
                    video.play();
                    cameraReady = true;
                    cameraPlaceholder.classList.add('hidden');
                    positionOverlay.classList.remove('hidden');
                    jumpMeter.classList.remove('hidden');
                    enableCameraBtn.classList.add('hidden');
                    startBtn.classList.remove('hidden');
                    startBtn.classList.add('flex');
                    statusText.textContent = 'CAMERA READY! STAND IN VIEW AND CLICK START';
                    
                    setTimeout(() => {
                        calibrateBaseline();
                        startContinuousDetection();
                    }, 1000);
                };
            } catch (err) {
                console.error('Camera error:', err);
                cameraReady = false;
                
                let errorMsg = 'CAMERA ERROR: ';
                if (err.name === 'NotAllowedError') errorMsg += 'PERMISSION DENIED';
                else if (err.name === 'NotFoundError') errorMsg += 'NO CAMERA FOUND';
                else if (err.name === 'NotReadableError') errorMsg += 'CAMERA IN USE';
                else errorMsg += err.message;
                
                errorMessage.textContent = errorMsg;
                errorMessage.classList.remove('hidden');
                statusText.textContent = 'CAMERA INITIALIZATION FAILED';
            }
        }

        function findHeadPosition() {
            if (!cameraReady || video.readyState !== video.HAVE_ENOUGH_DATA) return 0;

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0);
            
            const width = canvas.width;
            const height = canvas.height;
            const centerX = width / 2;
            const scanWidth = width * 0.5;
            
            for (let y = 0; y < height * 0.7; y += 2) {
                const rowData = ctx.getImageData(centerX - scanWidth/2, y, scanWidth, 1);
                let darkPixels = 0;
                
                for (let i = 0; i < rowData.data.length; i += 4) {
                    const brightness = (rowData.data[i] + rowData.data[i+1] + rowData.data[i+2]) / 3;
                    if (brightness < 100) darkPixels++;
                }
                
                if (darkPixels > scanWidth * 0.3) {
                    return y;
                }
            }
            
            return height / 2;
        }

        function calibrateBaseline() {
            if (!cameraReady) return;
            
            const headY = findHeadPosition();
            baselineHeadY = headY;
            headYHistory = [headY, headY, headY, headY, headY];
            console.log('Baseline calibrated:', baselineHeadY);
        }

        function startContinuousDetection() {
            function detect() {
                if (cameraReady) {
                    detectJump();
                    animationId = requestAnimationFrame(detect);
                }
            }
            detect();
        }

        function detectJump() {
            if (!cameraReady) return;
            
            const currentHeadY = findHeadPosition();
            
            headYHistory.push(currentHeadY);
            if (headYHistory.length > HISTORY_SIZE) {
                headYHistory.shift();
            }
            
            const avgHeadY = headYHistory.reduce((a, b) => a + b, 0) / headYHistory.length;
            const displacement = baselineHeadY - avgHeadY;
            
            headYText.textContent = Math.round(displacement);
            phaseText.textContent = jumpState.phase.toUpperCase();
            
            const heightPercent = Math.min(100, Math.max(0, (displacement / 80) * 100));
            jumpIndicator.style.height = heightPercent + '%';
            
            if (displacement > GOOD_THRESHOLD) {
                jumpIndicator.className = 'absolute bottom-0 w-full bg-gradient-to-t from-yellow-500 to-yellow-300 transition-all duration-100';
                positionText.textContent = 'HIGH JUMP';
                positionText.className = 'good-jump-glow';
            } else if (displacement > JUMP_THRESHOLD) {
                jumpIndicator.className = 'absolute bottom-0 w-full bg-gradient-to-t from-green-500 to-green-300 transition-all duration-100';
                positionText.textContent = 'JUMPING';
                positionText.className = 'neon-green';
            } else if (displacement < -GROUND_TOLERANCE) {
                jumpIndicator.className = 'absolute bottom-0 w-full bg-gradient-to-t from-gray-600 to-gray-400 transition-all duration-100';
                positionText.textContent = 'CROUCHING';
                positionText.className = 'partial-glow';
            } else {
                jumpIndicator.className = 'absolute bottom-0 w-full bg-gradient-to-t from-gray-600 to-gray-400 transition-all duration-100';
                positionText.textContent = 'ON GROUND';
                positionText.className = 'neon-green';
            }
            
            if (isActive) {
                processJumpStateMachine(displacement);
            }
        }

        function processJumpStateMachine(displacement) {
            switch(jumpState.phase) {
                case 'ground':
                    if (Math.abs(displacement) < GROUND_TOLERANCE) {
                        jumpState.groundFrames++;
                        
                        if (jumpState.groundFrames >= jumpState.requiredGroundFrames) {
                            jumpState.hasLeftGround = false;
                            jumpState.hasReachedPeak = false;
                            jumpState.maxHeightReached = 0;
                        }
                    } else {
                        jumpState.groundFrames = 0;
                    }
                    
                    if (displacement > JUMP_THRESHOLD && !jumpState.hasLeftGround) {
                        jumpState.phase = 'airborne';
                        jumpState.jumpStartY = baselineHeadY;
                        jumpState.maxHeightReached = displacement;
                        jumpState.hasLeftGround = true;
                        jumpState.groundFrames = 0;
                        console.log('TAKEOFF detected, displacement:', displacement);
                    }
                    break;
                    
                case 'airborne':
                    if (displacement > jumpState.maxHeightReached) {
                        jumpState.maxHeightReached = displacement;
                    }
                    
                    if (Math.abs(displacement) < GROUND_TOLERANCE) {
                        jumpState.phase = 'landed';
                        console.log('LANDING detected, max height was:', jumpState.maxHeightReached);
                    }
                    break;
                    
                case 'landed':
                    jumpState.groundFrames++;
                    
                    if (jumpState.groundFrames >= 3) {
                        if (jumpState.maxHeightReached >= JUMP_THRESHOLD) {
                            recordJump(jumpState.maxHeightReached);
                        }
                        
                        jumpState.phase = 'ground';
                        jumpState.groundFrames = 0;
                    }
                    break;
            }
        }

        function recordJump(maxHeight) {
            const heightInches = maxHeight * 0.5;
            
            totalJumpsCount++;
            totalJumps.textContent = totalJumpsCount;
            
            console.log('JUMP RECORDED! Height:', heightInches, 'inches');
            
            if (heightInches >= GOOD_THRESHOLD * 0.5) {
                goodJumpsCount++;
                goodJumps.textContent = goodJumpsCount;
                statusText.textContent = `✨ GOOD JUMP #${totalJumpsCount}! ${Math.round(heightInches)}" - EXCELLENT!`;
            } else if (heightInches >= JUMP_THRESHOLD * 0.5) {
                normalJumpsCount++;
                normalJumps.textContent = normalJumpsCount;
                statusText.textContent = `✓ NORMAL JUMP #${totalJumpsCount}! ${Math.round(heightInches)}" - KEEP GOING!`;
            } else {
                partialJumpsCount++;
                partialJumps.textContent = partialJumpsCount;
                statusText.textContent = `⚠ PARTIAL JUMP #${totalJumpsCount}! ${Math.round(heightInches)}" - JUMP HIGHER!`;
            }
            
            updateFitnessScore();
        }

        function updateFitnessScore() {
            const elapsedTime = 30 - timeLeft;
            if (elapsedTime === 0) return;
            
            const score = ((goodJumpsCount * 3) + (normalJumpsCount * 2) + (partialJumpsCount * 0.5)) / elapsedTime;
            fitnessScore.textContent = score.toFixed(1);
        }

        function startWorkout() {
            if (!cameraReady) return;
            
            isActive = true;
            totalJumpsCount = 0;
            normalJumpsCount = 0;
            goodJumpsCount = 0;
            partialJumpsCount = 0;
            timeLeft = 30;
            
            totalJumps.textContent = '0';
            normalJumps.textContent = '0';
            goodJumps.textContent = '0';
            partialJumps.textContent = '0';
            timerDisplay.textContent = '30';
            fitnessScore.textContent = '--';
            statusText.textContent = 'TEST STARTED! JUMP NOW!';
            
            jumpState = {
                phase: 'ground',
                maxHeightReached: 0,
                jumpStartY: 0,
                hasLeftGround: false,
                hasReachedPeak: false,
                groundFrames: 0,
                requiredGroundFrames: 10
            };
            
            calibrateBaseline();
            
            startBtn.classList.add('hidden');
            stopBtn.classList.remove('hidden');
            stopBtn.classList.add('flex');
            
            timerId = setInterval(() => {
                timeLeft--;
                timerDisplay.textContent = timeLeft;
                updateFitnessScore();
                
                if (timeLeft <= 0) {
                    stopWorkout();
                }
            }, 1000);
        }

        function stopWorkout() {
            isActive = false;
            
            statusText.textContent = `TEST COMPLETE! TOTAL: ${totalJumpsCount} | GOOD: ${goodJumpsCount} | NORMAL: ${normalJumpsCount} | PARTIAL: ${partialJumpsCount} | SCORE: ${fitnessScore.textContent}`;
            
            stopBtn.classList.add('hidden');
            startBtn.classList.remove('hidden');
            startBtn.classList.add('flex');
            
            if (timerId) {
                clearInterval(timerId);
                timerId = null;
            }
        }

        function reset() {
            if (isActive) {
                stopWorkout();
            }
            
            totalJumpsCount = 0;
            normalJumpsCount = 0;
            goodJumpsCount = 0;
            partialJumpsCount = 0;
            timeLeft = 30;
            
            totalJumps.textContent = '0';
            normalJumps.textContent = '0';
            goodJumps.textContent = '0';
            partialJumps.textContent = '0';
            timerDisplay.textContent = '30';
            fitnessScore.textContent = '--';
            jumpIndicator.style.height = '0%';
            
            statusText.textContent = cameraReady ? 'READY TO START!' : 'CLICK "ENABLE CAMERA" TO START';
            positionText.textContent = 'ON GROUND';
            headYText.textContent = '0';
            phaseText.textContent = 'GROUND';
            
            jumpState = {
                phase: 'ground',
                maxHeightReached: 0,
                jumpStartY: 0,
                hasLeftGround: false,
                hasReachedPeak: false,
                groundFrames: 0,
                requiredGroundFrames: 10
            };
            
            if (cameraReady) {
                calibrateBaseline();
            }
        }

        enableCameraBtn.addEventListener('click', enableCamera);
        startBtn.addEventListener('click', startWorkout);
        stopBtn.addEventListener('click', stopWorkout);
        resetBtn.addEventListener('click', reset);

        window.addEventListener('beforeunload', () => {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
            if (animationId) {
                cancelAnimationFrame(animationId);
            }
            if (timerId) {
                clearInterval(timerId);
            }
        });
    </script>
</body>
</html>